# TDD（テスト駆動開発）ワークフロー

## TDDサイクル

```
┌─────────────────────────────────────────┐
│                                         │
│   ┌───────┐                             │
│   │  Red  │ ← 失敗するテストを書く       │
│   └───┬───┘                             │
│       ↓                                 │
│   ┌───────┐                             │
│   │ Green │ ← テストが通る最小コード     │
│   └───┬───┘                             │
│       ↓                                 │
│   ┌──────────┐                          │
│   │ Refactor │ ← コードを改善           │
│   └────┬─────┘                          │
│        └────────→ 繰り返し              │
│                                         │
└─────────────────────────────────────────┘
```

## 実践手順

### Step 1: Red（失敗するテストを書く）

**目的**: 実装すべき振る舞いを明確にする

```python
# 例: ユーザー登録機能を実装したい

def test_ユーザー登録_正常():
    """まだ実装がないので失敗する"""
    service = UserService()
    user = service.register("test@example.com", "password123")
    
    assert user.email == "test@example.com"
    assert user.id is not None
```

**ポイント**:
- 1つの振る舞いに対して1つのテスト
- テスト名で「何をテストしているか」を明確に
- 実装前にテストを実行し、失敗を確認する

### Step 2: Green（テストを通す）

**目的**: 最短でテストを通す

```python
# 最小限の実装
class UserService:
    def register(self, email: str, password: str) -> User:
        return User(id=1, email=email)
```

**ポイント**:
- 完璧なコードを書かない
- ハードコードでもOK
- とにかくテストを通すことだけを考える

### Step 3: Refactor（改善する）

**目的**: コードの品質を上げる

```python
# リファクタリング後
class UserService:
    def __init__(self, repository: UserRepository):
        self.repository = repository
    
    def register(self, email: str, password: str) -> User:
        if not self._is_valid_email(email):
            raise ValueError("Invalid email")
        
        hashed = self._hash_password(password)
        user = User(email=email, password_hash=hashed)
        return self.repository.save(user)
```

**ポイント**:
- テストが通る状態を維持
- 重複を排除
- 命名を改善
- 責務を分離

## TDDセッションの進め方

### 機能追加の流れ

```
1. 要件を小さなタスクに分解
   例: 「ユーザー登録機能」
   → メールバリデーション
   → パスワードハッシュ化
   → DB保存
   → 重複チェック

2. 最も単純なタスクから開始
   → メールバリデーションから始める

3. Red-Green-Refactor を繰り返す

4. 次のタスクへ
```

### テストリスト（TODO）

開発前にテストリストを作成:

```markdown
## ユーザー登録

- [ ] 正常なメールアドレスで登録できる
- [ ] 不正なメールアドレスでエラー
- [ ] パスワードが8文字未満でエラー
- [ ] 既存メールアドレスでエラー
- [ ] 登録後にIDが付与される
- [ ] パスワードがハッシュ化される
```

## Claude での TDD セッション

### 開始方法

```
あなた: TDDでユーザー認証機能を開発したい

Claude: 了解！TDDで進めましょう。
        
        まずテストリストを作成します：
        - [ ] 正しい認証情報でログイン成功
        - [ ] 間違ったパスワードで失敗
        - [ ] 存在しないユーザーで失敗
        ...
        
        最初のテスト「正しい認証情報でログイン成功」
        から始めましょう。
        
        【Red】失敗するテストを書きます：
        [テストコード]
        
        このテストを実行してください。失敗を確認したら
        教えてください。
```

### 進行パターン

```
Claude: 【Red】テストを書きました
        → テスト実行してください

あなた: 失敗した

Claude: 【Green】最小実装を書きます
        → テスト実行してください

あなた: 通った

Claude: 【Refactor】改善点はありますか？
        なければ次のテストへ進みます
```

## アンチパターン

| NG | 理由 |
|----|------|
| テストなしでコードを書く | TDDの意味がない |
| 複数のテストを一度に書く | フィードバックが遅くなる |
| テストを通す前にリファクタ | 失敗原因が不明になる |
| 完璧なコードを最初から書く | Greenフェーズが長くなる |

## TDDのメリット

1. **設計が改善**: テストしやすい = 疎結合
2. **バグ減少**: 小さく検証しながら進む
3. **ドキュメント**: テストが仕様書になる
4. **自信を持ってリファクタ**: テストが安全網
