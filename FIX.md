# 修正履歴 (FIX.md)

このドキュメントは、A1-PROプロジェクトで行った修正内容を記録します。

---

## 2026-02-02 - 初期セットアップとUI改善

### 1. データベースセットアップ (Commit: 92c3fc9)

#### 問題
- データベース `a1pro` が存在しない
- テーブルが作成されていない
- サンプルデータが登録されていない

#### 修正内容
- MySQLデータベース `a1pro` を作成
- SQLAlchemyモデルから全テーブルを作成:
  - `companies` (企業マスタ)
  - `financial_data` (決算データ)
  - `stock_prices` (株価データ)
  - `portfolio` (ポートフォリオ)
  - `favorites` (お気に入り)
- サンプル企業データ10社を登録:
  - 7203: トヨタ自動車
  - 9984: ソフトバンクグループ
  - 6758: ソニーグループ
  - 9433: KDDI
  - 8306: 三菱UFJフィナンシャル・グループ
  - 6861: キーエンス
  - 7974: 任天堂
  - 4063: 信越化学工業
  - 6902: デンソー
  - 8035: 東京エレクトロン

#### 変更ファイル
- `SETUP.md` (新規作成)
- `backend/.env` (新規作成 - Gitには含まれない)
- `frontend/.env.local` (新規作成 - Gitには含まれない)

---

### 2. 入力テキスト可視性の改善 (Commit: 11dcefd)

#### 問題
- 銘柄検索の入力欄で、入力したテキストが白色で見にくい
- チャット入力欄でも同様の問題

#### 修正内容
- 検索バーの入力欄に `text-gray-900` クラスを追加
- `frontend/app/globals.css` の `.input` クラスに `text-gray-900` を追加
- チャット入力欄に `text-gray-900` クラスを追加

#### 変更ファイル
- `frontend/app/globals.css:18` - `.input` クラスに `text-gray-900` を追加
- `frontend/components/ChatBot.tsx:202` - 入力欄に `text-gray-900` を追加

---

### 3. 検索ボタンの追加とUX改善 (Commit: 361509a)

#### 問題
- 銘柄検索が自動で実行されるため、意図しないタイミングで検索が走る
- ユーザーが明示的に検索を実行したい

#### 修正内容
- 検索ボタンを追加（入力欄の右側）
- 自動検索（debounce）から、ボタントリガー型の検索に変更
- Enterキーでも検索実行可能に
- 検索中はローディングスピナーを表示
- クエリが空の場合はボタンを無効化

#### 変更ファイル
- `frontend/components/SearchBar.tsx` - 全面的にリファクタリング
  - `useEffect` と debounce ロジックを削除
  - `handleSearch` 関数を追加（ボタンクリック時に実行）
  - `handleKeyPress` 関数を追加（Enterキー対応）
  - レイアウトを flex に変更（入力欄とボタンを横並び）

---

### 4. 追加企業データの登録 (Commit: 591bdaa)

#### 問題
- 銘柄コード 7230 (日産自動車) で検索しても「該当する銘柄が見つかりません」と表示される

#### 修正内容
- 日産自動車 (7230) のデータをデータベースに追加
  - 銘柄コード: 7230
  - 企業名: 日産自動車
  - 業種: 輸送用機器
  - 説明: 自動車メーカー。ルノー・日産・三菱アライアンスの一角。

#### 変更ファイル
- データベース直接操作（INSERT文）

---

### 5. APIタイムアウトの延長 (Commit: 757cf48)

#### 問題
- フロントエンドのAPIリクエストで30秒のタイムアウトが発生
- コンソールに "timeout of 30000ms exceeded" エラーが表示
- バックエンドの起動時にOllamaやChromaDBの初期化に時間がかかる

#### 修正内容
- Axiosクライアントのタイムアウトを30秒から60秒に延長
- バックエンドは正常に動作していることを確認

#### 変更ファイル
- `frontend/services/api.ts:24` - `timeout: 30000` → `timeout: 60000`

---

### 6. 決算データの追加 (Commit: b6fe3af)

#### 問題
- 企業情報は表示されるが、決算データが登録されていないため「決算データが登録されていません」と表示される
- グラフや財務指標が表示されない

#### 修正内容
- トヨタ自動車(7203)の決算データを追加（2019-2023年度）
- 日産自動車(7230)の決算データを追加（2019-2023年度）
- 各年度の以下のデータを登録:
  - 売上高 (revenue)
  - 営業利益 (operating_profit)
  - 経常利益 (ordinary_profit)
  - 純利益 (net_profit)
  - 総資産 (total_assets)
  - 自己資本 (equity)
  - 総負債 (total_liabilities)
  - 流動資産 (current_assets)
  - 流動負債 (current_liabilities)

#### 変更ファイル
- データベース直接操作（INSERT文）

---

### 7. React Key警告の修正と全企業データ追加 (Commit: dc582b5)

#### 問題
- コンソールに "Each child in a list should have a unique 'key' prop" エラーが表示
- チャートの `<circle>` 要素に key が設定されていない
- 残りの企業（ソフトバンク、ソニー、KDDI等）の決算データが未登録

#### 修正内容
- **React Key警告の修正**:
  - RevenueChart.tsx
  - OperatingProfitChart.tsx
  - NetProfitChart.tsx
  - EquityRatioChart.tsx
  - CurrentRatioChart.tsx
  - ROEChart.tsx
  - OperatingMarginChart.tsx
  - 各チャートの `dot` prop 内の `<circle>` 要素に `key={`dot-${payload.fiscal_year}-${index}`}` を追加

- **決算データの追加**（2019-2023年度、各5年分）:
  - ソフトバンクグループ (9984)
  - ソニーグループ (6758)
  - KDDI (9433)
  - 三菱UFJフィナンシャル・グループ (8306)
  - キーエンス (6861)
  - 任天堂 (7974)
  - 信越化学工業 (4063)
  - デンソー (6902)
  - 東京エレクトロン (8035)

#### 変更ファイル
- `frontend/components/charts/*.tsx` - 全チャートコンポーネント
- データベース直接操作（INSERT文）

---

### 8. 東証プライム銘柄の大量追加 (Commit: 現在の作業)

#### 問題
- 登録されている銘柄数が少ない（11社のみ）
- 東証プライム市場の全銘柄（約1800社）をカバーしたい

#### 修正内容
- **銘柄データインポートスクリプトの作成**:
  - `backend/scripts/prime_companies.csv` - 東証プライム主要175社のCSVリスト
  - `backend/scripts/import_csv_companies.py` - CSV→DB登録スクリプト
  - `backend/scripts/fetch_prime_companies.py` - JPXからの自動取得スクリプト（将来用）

- **追加した銘柄**（175社、主要セクター）:
  - 水産・農林業: 3社
  - 鉱業: 2社
  - 建設業: 10社
  - 食料品: 11社
  - 繊維製品: 4社
  - パルプ・紙: 2社
  - 化学: 15社
  - 医薬品: 8社
  - 石油・石炭: 2社
  - ゴム製品: 2社
  - ガラス・土石: 7社
  - 鉄鋼: 4社
  - 非鉄金属: 6社
  - 機械: 10社
  - 電気機器: 24社
  - 輸送用機器: 15社
  - 精密機器: 4社
  - その他製品: 4社
  - 卸売業: 8社
  - 小売業: 4社
  - 銀行業: 10社
  - 証券・商品先物: 2社
  - 保険業: 3社
  - 不動産業: 3社
  - 陸運業: 7社
  - 海運業: 3社
  - 空運業: 1社
  - 倉庫・運輸: 1社
  - 情報・通信業: 5社
  - サービス業: 2社

- **データベース統計**:
  - 登録前: 11社
  - 新規追加: 164社
  - 登録後合計: 175社

#### 変更ファイル
- `backend/scripts/prime_companies.csv` (新規作成)
- `backend/scripts/import_csv_companies.py` (新規作成)
- `backend/scripts/fetch_prime_companies.py` (新規作成)

---

### 9. 決算データ自動取得スクリプトの追加 (Commit: 2000f79)

#### 問題
- 175社の銘柄が登録されたが、決算データは11社分のみ
- 手動でデータを追加するのは現実的ではない
- バフェット・コードAPIを活用した自動取得が必要

#### 修正内容
- **決算データ自動取得スクリプトの作成**:
  - `backend/scripts/fetch_financials_buffett.py` - バフェット・コードAPI連携スクリプト
  - 決算データがない企業を自動検出
  - API経由で通期決算データを取得
  - データベースに自動登録
  - API制限対策（1秒/リクエスト、月500リクエスト）

- **ドキュメント作成**:
  - `backend/scripts/README.md` - スクリプトの使用方法とセットアップガイド
  - APIキー取得方法
  - 実行例とトラブルシューティング

#### 使用方法
```bash
cd backend
source venv/bin/activate
export BUFFETT_CODE_API_KEY='your_api_key'
python scripts/fetch_financials_buffett.py
```

#### 変更ファイル
- `backend/scripts/fetch_financials_buffett.py` (新規作成)
- `backend/scripts/README.md` (新規作成)

---

### 10. 主要企業の決算データ追加 (Commit: 現在の作業)

#### 問題
- 175社の銘柄が登録されているが、決算データは11社分のみ
- ユーザーが検索してもグラフやデータが表示されない
- 手動でより多くのデータを追加する必要がある

#### 修正内容
- **主要企業9社の決算データを追加**（2019-2023年度、各5年分）:
  - 大成建設 (1801)
  - 大林組 (1802)
  - 大和ハウス工業 (1925)
  - 武田薬品工業 (4502)
  - ブリヂストン (5108)
  - 小松製作所 (6301)
  - セブン&アイ・ホールディングス (3382)
  - 日立製作所 (6501)
  - 三菱電機 (6503)

- **データベース統計**:
  - 決算データ登録前: 11社
  - 新規追加: 9社
  - 登録後合計: **20社**

- **各企業のデータ内容**:
  - 5年分の通期決算データ（2019-2023）
  - 売上高、営業利益、経常利益、純利益
  - 総資産、自己資本、総負債
  - 流動資産、流動負債

#### 動作確認済み銘柄
以下の20社でグラフとデータが正常に表示されます:
- 建設: 大成建設、大林組、大和ハウス工業
- 化学: 信越化学工業
- 医薬品: 武田薬品工業
- ゴム: ブリヂストン
- 機械: 小松製作所
- 電気機器: ソニーグループ、キーエンス、東京エレクトロン、日立製作所、三菱電機
- 輸送用機器: トヨタ自動車、日産自動車、デンソー
- その他製品: 任天堂
- 小売: セブン&アイ・ホールディングス
- 銀行: 三菱UFJフィナンシャル・グループ
- 情報通信: KDDI、ソフトバンクグループ

#### 変更ファイル
- データベース直接操作（INSERT文）

---

## 既知の問題

### 1. Next.js バージョン不一致警告
- 症状: `@next/swc` のバージョンが Next.js のバージョンと一致していない (15.5.7 vs 15.5.11)
- 影響: 低（警告のみ、機能には影響なし）
- 対処: `npm install` で依存関係を更新することで解消可能

### 2. ChromaDB テレメトリーエラー
- 症状: バックエンドログに ChromaDB テレメトリー送信エラーが表示
- 影響: なし（テレメトリーのみの問題、RAG機能は正常動作）
- 対処: 無視して問題なし

### 3. LangChain 非推奨警告
- 症状: `Ollama` クラスが非推奨との警告
- 影響: なし（現時点では正常動作）
- 対処: 将来的に `langchain-ollama` パッケージに移行が必要

---

## 次回以降の修正予定

- [ ] Next.js の swc バージョン不一致を解消
- [ ] RAG チャットボット機能の動作確認とテスト
- [ ] 株価データ取得機能の実装（yfinance連携）
- [ ] 東証プライム全銘柄（約1800社）の追加
- [ ] 東証スタンダード・グロース市場の銘柄追加
- [ ] バフェット・コードAPIを使った決算データ自動取得
- [x] グラフ表示機能の実装（完了 - Phase 2）
- [x] 東証プライム主要175社の追加（完了）

---

## 開発環境

- **バックエンド**: http://localhost:8000
- **フロントエンド**: http://localhost:3000
- **データベース**: MySQL 8.0 (localhost:3306)
- **LLM**: Ollama (localhost:11434)

---

**最終更新**: 2026-02-02
